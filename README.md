# auth-tdd-jwt
authentication with jwt using tdd sequelize

 yarn init -y
 yarn add express
 yarn add sequelize pg   (sequelize we will utilize this ORM (Object relational Mapper). Sequelize maps relational data  to javascript objects.

 yarn add sequelize-cli -D  (install only as dev. Dependency)

 yarn sequelize ini  (remember to run it to create the files inside the project)

Its mandatory to isolate the port listening, express with the business rule because we want to apply TDD (Test Driven Development) only to the business rule and not to the server logic and others stuffs.

Project structure :







Finishing project structure : Observe the explorer side window. The files and folders that were created and moved.







Migrations does DB version control and guarantee the db is always functional and dont break due version issues.

 yarn sequelize migration:create --name=create-users

Move the files created by sequelize to the right folders : 






Download postgress and setup it in your local machine

docker pull postgres:9.6.22-alpine

On terminal:

docker run --name tdd-jwt-auth -e POSTGRES_PASSWORD=12345 -d -p 5432:5432 postgres

Create DB as indicated on the database.js property

docker exec -it 42e0186df1c1 bash

docker exec -it 05b3a3471f6f bash
root@05b3a3471f6f:/# psql -U postgres
postgres-# CREATE DATABASE nodeauth;

Results: 

➜ yarn sequelize db:migrate
yarn run v1.22.5
warning ../../package.json: No license field
$ /Users/apantbr.ibm.com/projetos/tdd-jwt-auth/node_modules/.bin/sequelize db:migrate

Sequelize CLI [Node: 14.17.0, CLI: 6.2.0, ORM: 6.6.2]

Loaded configuration file "src/config/database.js".
== 20210615121231-create-users: migrating =======
== 20210615121231-create-users: migrated (0.188s)

✨  Done in 2.33s.





Creating Models




Doing some small changes on the auto generated model/index up to line 16




Lets test :





Ops....



Lets run undo and migrate again

yarn sequelize db:migrate:undo
yarn sequelize db:migrate

Yep.... It worked................


I checked on Postico


Lets install Nodemon as Dev. Dependency

yarn add nodemon -D


Starting setup JEST

Lets set nodemon to watch changes, except any change did on the __tests__ folder.



Lets install jest as dependency of development

 yarn add jest -D





Lets change the file created by jest init






Testing







Lets create .env and .env.test




  yarn add dotenv
yarn add sqlite3 -D




Setup package.json test entry to node_env







Its important to run before all the migrations to the sqlite test database so we can run tests after that




Lets change package.json

"scripts": {
"start": "node src/server.js",
"dev": "nodemon src/server.js --ignore __tests__",
"pretest": "NODE_ENV=test sequelize db:migrate",
"test": "NODE_ENV=test jest",
"posttest": "NODE_ENV=test sequelize db:migrate:undo:all"


And test it : Check that the preTest, test and posttest was executed fine.






We can create our tests. Remember that Jest does not implement routes and we need to create on the tests a user and try to return it thru our post.

Lets install yarn add supertest -D

And begin implementing tests




Lets encrypt password 

  yarn add bcryptjs





Implementing jwt token

 yarn add jsonwebtoken





Coverage Tests




First type of coverage output : 
We can check how much in percentage was tested.



A better coverage output by html provided: Jest generates a folder inside __tests__



Opening index.html generated by Jest : 




![image](https://user-images.githubusercontent.com/14879580/122140426-9f7dda80-ce21-11eb-9717-d112f41b306b.png)
